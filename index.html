<!DOCTYPE html>
<html>

<head>
    <title>Cytometry Vis </title>
    <!-- Required meta tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">-->
</head>

<style>
    th {color: white; padding:10px;}
    div.tooltip {
       color:white;
       position: absolute;
       text-align: left;
       width: 600px;
       min-height: 35px;
       padding: 5px 10px 5px 10px;
       font: 14px sans-serif;
       background: steelblue;
       border: 0px;
       border-radius: 8px;
       pointer-events: none;
     }

</style>

<body>
    <svg width="1300" height="900" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>

</body> 

<script>
    var svg = d3.select("svg"),
    width = svg.attr("width")-100,
    height = svg.attr("height"),
    columns=3,
    lines=1,
    //piecew=width/columns,
    pieceh=height/lines,
    itemsize=31,
    strokewidth=2,
    padding=20,
    heightofbox=0.95*pieceh,
    hasTooltips=true,
    marginfortitles=40;

    const reducer = (accumulator, currentValue) => accumulator + currentValue;
    var flwidths=[0.175,0.51,0.27];
    var piecew=[];
    var xZeros=[];
    flwidths.forEach(function(w){ piecew.push(w*width)});
    piecew.forEach(function(w,i){ xZeros.push(piecew.slice(0,i).reduce(reducer,marginfortitles))});
    var flheights=[0.35,0.26,0.26];
    var pieceh=[];
    var yZeros=[];
    flheights.forEach(function(h){ pieceh.push(h*heightofbox)});
    pieceh.forEach(function(h,i){ yZeros.push(pieceh.slice(0,i).reduce(reducer,marginfortitles))});

    var tt = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

    //First level categories (Mod
    var labelflc=[ "Image Processing", "Classification", "Segmentation", "Others"];
    var flc=["P","C","S"];//,"O" ];
    //second level categories
    var labelslc=[ "Brightfield", "Electron", "Fluorescence", "Other (4)"];
    var slc=["BF","EM","FL"];//,"O" ];
    //third level category
    var labeltlc=[ "Tissue", "Cellular", "Sub-cellular", "Other" ];
    var tlc=[ "T", "CL", "SB"];//"O"];
     
    //Colors for categories from color oracle
    var colorflc=[ "#0773b3", "#b15a8b" ,"#d36027" ,"#f2e646"];
    //var colorslc=[ "#cc7aa8" , "#1791da" ,"#00a074" ,"#e79f27"];
    var colorslc=[ "#33ba95", "#82dec5","#cbf5ea" ,"#d7f7ee"];
    var colortlc=[ "#cc7aa8" ,"#00a074","#28abf9", "#ffbf54"];

    var flcn=flc.length;
    var slcn=slc.length;
    var tlcn=tlc.length;

    //This horrible way of initializing is because I didn't know how to do it in one go
    //because Javascript doesn't allow for a recursive way of initializing objects.
    var tableentries=[];
    var allobjmap={};
    for(var i=0;i<flcn;i++){
        allobjmap[flc[i]]={};
    }

    for(var i=0;i<flcn;i++){
        for(var j=0;j<slcn;j++){
            allobjmap[flc[i]][slc[j]]={};         
    }   }
    

    for(var i=0;i<flcn;i++){
        for(var j=0;j<slcn;j++){
            for(var k=0;k<tlcn;k++){
                allobjmap[flc[i]][slc[j]][tlc[k]]=[];
    }   }   }

    //These will be the SVG groups to store the little groups of each category
    var groups={};

    //Background rectangle container
    var bg=svg.append("g")
       .attr("x", 0)
       .attr("y", 0)
       .attr("width", width)
       .attr("height", height)
       .attr("fill","transparent")
       .attr("class","background");

    //this function takes a compound key and creates two entries
    var subentries=function(entry){
        var allthewaydown=false;
        var isFLC=false, isSLC=false, isTLC=false;
        var theFLC="",theSLC="",theTLC="";
        for(var i=0;i<flcn;i++){
            if(entry.flc.includes(flc[i])){
                for(var j=0;j<slc.length;j++){
                    if(entry.slc.includes(slc[j])){
                       for(var k=0;k<tlc.length;k++){
                           if(entry.tlc.includes(tlc[k])){
                              allobjmap[flc[i]][slc[j]][tlc[k]].push(entry);
    }   }   }   }   }   }  }
                      
    //add empty groups for the little items
    for(var i=0;i < flc.length;i++){
        groups[flc[i]]={};
        for(var j=0;j < slc.length;j++){
            groups[flc[i]][slc[j]]=svg.append("g")
               .attr("transform","translate("+(xZeros[i]+padding)+","+(padding+yZeros[j])+")")
               .attr("class",flc[i]+"-"+slc[j]);
        }
    }

    //Add the rectangles and lines for the first level categroies (FLC)
    var labeltext=bg.append("g");
    for(var i=0;i < flcn;i++){
       bg.append("rect")
          .attr("class",flc[i]).attr("x", xZeros[i]+strokewidth).attr("y", yZeros[0]+strokewidth)
          .attr("width", piecew[i]).attr("height", pieceh.reduce(reducer,0)-strokewidth).attr("fill","#ffffff00")
          .attr("stroke","#000000").attr("stroke-width",strokewidth);
       bg.append("rect")
          .attr("class",flc[i]).attr("x", 0+strokewidth+xZeros[i]).attr("y", 0+strokewidth)
          .attr("width", piecew[i]).attr("height",yZeros[0]).attr("fill","#ffffff00")
          .attr("stroke","#000000").attr("stroke-width",strokewidth);
       bg.append("rect")
          .attr("class",flc[i]).attr("x", 0+strokewidth).attr("y", yZeros[i]+strokewidth)
          .attr("width", xZeros[0]).attr("height",pieceh[i]-strokewidth).attr("fill","#ffffff00")
          .attr("stroke","#000000").attr("stroke-width",strokewidth);
       var fsize=22; 
       labeltext.append("text").attr("x",strokewidth+xZeros[i]+piecew[i]/2).attr("y",fsize*1.25)
          .attr("font-family","sans-serif").attr("font-size",fsize).attr("font-weight","bold")
          .attr("fill","black")
          .text(labelflc[i]);



       for(var j=1;j < slc.length;j++){
           bg.append("line").attr("x1",xZeros[i]+strokewidth).attr("y1",yZeros[j])
              .attr("x2",(xZeros[i]+width*flwidths[i]+strokewidth)).attr("y2", yZeros[j] )
              .attr("stroke-width", strokewidth).attr("stroke","#000000" );
       }
   }

   for(var j=0;j < slcn;j++){
       var fsize=22;
       var x=strokewidth+xZeros[0]/2+fsize*0.4;
       var y=yZeros[j]+pieceh[j]/2;
       var ag=labeltext.append("g").attr("transform","translate("+x+","+y+"),rotate(-90)");
           ag.append("text")
           .attr("font-family","sans-serif").attr("font-size",fsize).attr("font-weight","bold")
           .attr("fill","black")
           .text(labelslc[j]);

   }
    //Make a xhtmlrequest to bring the TSV with the help of D3
    var req=d3.tsv("CytoTable.tsv",function(d){ tableentries.push(d); return d;},function(rows){
        //Nest entries accodring to categories
	var allentries = d3.nest().key(function(d){ return d["flc"]; })
				  .key(function(d){ return d["slc"]; })
				  .key(function(d){ return d["tlc"]; }).entries(rows);
	rows.forEach(function(d){
            subentries(d);
        });        
 
        
        for(var i=0;i<flcn;i++){
            for(var j=0;j<slcn;j++){
                var count=0,x=0,y=0;
                for(var k=0;k<tlc.length;k++){
                    //find if there are objects in this category
                    var aGroup=allobjmap[flc[i]][slc[j]][tlc[k]];
                    if(aGroup.length>0){
                        aGroup.forEach(function(entry){
                           //line return within each group
                           if(x>piecew[i]-itemsize/2-padding*2){
                               x=0; y+=itemsize+5;
                           }
                           var rectg=groups[flc[i]][slc[j]].append("g").attr("transform","translate("+x+","+y+")");
                           //add a lttle colored rectangle of the appropriate color
                           rectg.append("rect").attr("x",0).attr("y", 0).attr("fill",colortlc[k])
                               .attr("width", itemsize).attr("height",itemsize);
                           
                           var fontsize=itemsize/1.65;
                           var multiplier=1;
                           if(entry.id.length==2) multiplier=0.9;
                           if(entry.id.length>=3) multiplier=0.8;
                           
                           rectg.append("text").attr("x",itemsize/2).attr("y",itemsize*(0.7))
			      .attr("font-family","sans-serif").attr("font-size",(fontsize*multiplier)+"px").attr("font-weight","bold")
                              .attr("fill","white")
                              .text(entry.id);
                           //If you print the invisible tooltips they will appear in the SVG, set this to false when saving the SVG
                           if(hasTooltips) {
                              rectg.append("rect").attr("x",0).attr("y", 0).attr("fill","rgba(0,0,0,0)").attr("class","toolts")
                                  .attr("width", itemsize).attr("height",itemsize)
                                  .on("mouseover", function(d) {
                                     var innerhtml="<p><b>"+entry.title+"</b></p>"+
                                          "<p><i>"+entry.author+"</i></p>"+
                                          "<p>"+entry.summary+"</p>";
                                     tt.transition().duration(200).style("opacity", .9);
                                     tt.html(innerhtml).style("left", (d3.event.pageX) + "px")
                                       .style("top", (d3.event.pageY - 28) + "px");
                                  })
                                  .on("mouseout", function(d) {
                                     tt.transition().duration(500).style("opacity", 0);
                                  });
                            }            
                            x+=itemsize+5;
                        });
                    }
                }
            }
        }
     }); //End of the call of the TSV
     
     infoOfTitle=function(id){
         tableentries.forEach(function(d){if (d.id==42){console.log(d)}  });
     }
     
     var saveSVG=function(){
         d3.selectAll(".toolts").remove();
         var svgData = svg._groups[0][0].outerHTML;
         var svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
         var svgUrl = URL.createObjectURL(svgBlob);
         var downloadLink = document.createElement("a");
         downloadLink.href = svgUrl;
         downloadLink.download = "newesttree.svg";
         document.body.appendChild(downloadLink);
         downloadLink.click();
         document.body.removeChild(downloadLink); 
     }
</script>
